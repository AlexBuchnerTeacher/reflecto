name: Enable Auto-merge for Dependabot PRs

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  collect:
    runs-on: ubuntu-latest
    outputs:
      pr_numbers: ${{ steps.collect.outputs.pr_numbers }}
    steps:
      - name: Collect open Dependabot PR numbers
        id: collect
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            let page = 1;
            const prs = [];
            while (true) {
              const { data } = await github.rest.pulls.list({ owner, repo, state: 'open', per_page: 100, page });
              if (!data.length) break;
              for (const pr of data) {
                if (pr.user && pr.user.login === 'dependabot[bot]') prs.push(pr.number);
              }
              page++;
            }
            core.setOutput('pr_numbers', JSON.stringify(prs));
            core.info(`Found ${prs.length} Dependabot PRs: ${prs.join(', ')}`);

  enable:
    needs: collect
    if: ${{ needs.collect.outputs.pr_numbers != '[]' && needs.collect.outputs.pr_numbers != '' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pr: ${{ fromJson(needs.collect.outputs.pr_numbers) }}
    steps:
      - name: Enable auto-merge
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ matrix.pr }}
          merge-method: squash

